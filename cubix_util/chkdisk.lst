                      (      chkdisk.asm):00001         ;*
                      (      chkdisk.asm):00002         ;* CHKDISK: File system allocaton and disk media check.
                      (      chkdisk.asm):00003         ;*
                      (      chkdisk.asm):00004         ;* Copyright 1983-2005 Dave Dunfield
                      (      chkdisk.asm):00005         ;* All rights reserved.
                      (      chkdisk.asm):00006         ;*
     2000             (      chkdisk.asm):00007         OSRAM           = $2000       APPLICATION RAM AREA
     DBFF             (      chkdisk.asm):00008         OSEND           = $DBFF       END OF GENERAL RAM
     D000             (      chkdisk.asm):00009         OSUTIL          = $D000       UTILITY ADDRESS SPACE
     0000             (      chkdisk.asm):00010         DIRLOC          = 0                               ;DIRECTORY LOCATION
     0001             (      chkdisk.asm):00011         LNKLOC          = 1                               ;LINK SECTOR LOCATION
                      (      chkdisk.asm):00012         ;* DIRECTORY STRUCTURE
                      (      chkdisk.asm):00013                 ORG     0
0000                  (      chkdisk.asm):00014         DPREFIX
0000                  (      chkdisk.asm):00015                 RMB     8                                 ;PREFIX
0008                  (      chkdisk.asm):00016         DNAME
0008                  (      chkdisk.asm):00017                 RMB     8                                 ;FILENAME
0010                  (      chkdisk.asm):00018         DTYPE
0010                  (      chkdisk.asm):00019                 RMB     3                                 ;FILE TYPE
0013                  (      chkdisk.asm):00020         DDADR
0013                  (      chkdisk.asm):00021                 RMB     2                                 ;DISK ADDRESS
0015                  (      chkdisk.asm):00022         DRADR
0015                  (      chkdisk.asm):00023                 RMB     2                                 ;RUN ADDRESS
0017                  (      chkdisk.asm):00024         DATTR
0017                  (      chkdisk.asm):00025                 RMB     1                                 ;FILE ATTRIBUTES
                      (      chkdisk.asm):00026         ;*
                      (      chkdisk.asm):00027                 ORG     OSRAM                             ;PUT IT HERE
2000                  (      chkdisk.asm):00028         CHKDISK
2000 813F             (      chkdisk.asm):00029                 CMPA    #'?'                              ;HELP REQUEST?
2002 2639             (      chkdisk.asm):00030                 BNE     QUAL                              ;NO, DO FSCK
2004 3F               (      chkdisk.asm):00031                 SWI
2005 19               (      chkdisk.asm):00032                 FCB     25
2006 5573653A2043484B (      chkdisk.asm):00033                 FCN     'Use: CHKDISK[/NOALLOC/NOMEDIA/QUIET/REBUILD] <drive>'
     4449534B5B2F4E4F
     414C4C4F432F4E4F
     4D454449412F5155
     4945542F52454255
     494C445D203C6472
     6976653E00
203B                  (      chkdisk.asm):00034         ABORT
203B 3F               (      chkdisk.asm):00035                 SWI
203C 00               (      chkdisk.asm):00036                 FCB     0                                 ;RETURN TO DOS
                      (      chkdisk.asm):00037         ;* EVALUATE QUALIFIERS
203D                  (      chkdisk.asm):00038         QUAL
203D A6A4             (      chkdisk.asm):00039                 LDA     ,Y                                ;GET CHAR
203F 812F             (      chkdisk.asm):00040                 CMPA    #'/'                              ;QUALIFIER?
2041 263A             (      chkdisk.asm):00041                 BNE     MAIN                              ;NO QUALIFIERS
2043 8E23DC           (      chkdisk.asm):00042                 LDX     #QTABLE                           ;PT TO TABLE
2046 3F               (      chkdisk.asm):00043                 SWI
2047 12               (      chkdisk.asm):00044                 FCB     18                                ;LOOK IT UP
2048 C104             (      chkdisk.asm):00045                 CMPB    #QMAX                             ;OVER?
204A 2407             (      chkdisk.asm):00046                 BHS     QERR                              ;INVALID
204C 8E23FF           (      chkdisk.asm):00047                 LDX     #QFLAGS                           ;PT TO FLAGS
204F 6F85             (      chkdisk.asm):00048                 CLR     B,X                               ;ZAP IT
2051 20EA             (      chkdisk.asm):00049                 BRA     QUAL                              ;CONTINUE
2053                  (      chkdisk.asm):00050         QERR
2053 3F               (      chkdisk.asm):00051                 SWI
2054 18               (      chkdisk.asm):00052                 FCB     24                                ;MESSAGE
2055 496E76616C696420 (      chkdisk.asm):00053                 FCN     'Invalid qualifier: '
     7175616C69666965
     723A2000
2069 A6A0             (      chkdisk.asm):00054                 LDA     ,Y+                               ;GET CHAR
206B                  (      chkdisk.asm):00055         QERR1
206B 3F               (      chkdisk.asm):00056                 SWI
206C 21               (      chkdisk.asm):00057                 FCB     33                                ;OUTPUT
206D 3F               (      chkdisk.asm):00058                 SWI
206E 05               (      chkdisk.asm):00059                 FCB     5                                 ;GET NEXT CHAR
206F 2704             (      chkdisk.asm):00060                 BEQ     QERR2                             ;END, EXIT
2071 812F             (      chkdisk.asm):00061                 CMPA    #'/'                              ;NEXT QUALIFIER
2073 26F6             (      chkdisk.asm):00062                 BNE     QERR1                             ;ITS OK
2075                  (      chkdisk.asm):00063         QERR2
2075 3F               (      chkdisk.asm):00064                 SWI
2076 19               (      chkdisk.asm):00065                 FCB     25
2077 2700             (      chkdisk.asm):00066                 FCB     $27,00
2079 8601             (      chkdisk.asm):00067                 LDA     #1                                ;INDICATE INVALID OPERAND
207B 20BE             (      chkdisk.asm):00068                 BRA     ABORT                             ;ERROR
                      (      chkdisk.asm):00069         ;*
                      (      chkdisk.asm):00070         ;* PERFORM TESTS
                      (      chkdisk.asm):00071         ;*
207D                  (      chkdisk.asm):00072         MAIN
207D 3F               (      chkdisk.asm):00073                 SWI
207E 58               (      chkdisk.asm):00074                 FCB     88                                ;CLEAN DISK
207F 3F               (      chkdisk.asm):00075                 SWI
2080 10               (      chkdisk.asm):00076                 FCB     16                                ;GET DRIVE ID
2081 26B8             (      chkdisk.asm):00077                 BNE     ABORT                             ;INVALID OPERAND
2083 3F               (      chkdisk.asm):00078                 SWI
2084 4C               (      chkdisk.asm):00079                 FCB     76                                ;SELECT DRIVE
2085 3F               (      chkdisk.asm):00080                 SWI
2086 52               (      chkdisk.asm):00081                 FCB     82                                ;GET ITS SIZE
2087 FD2409           (      chkdisk.asm):00082                 STD     >DRVSIZ                           ;SAVE DRIVE SIZE
208A 830001           (      chkdisk.asm):00083                 SUBD    #1                                ;ACTUAL HIGEST SECTOR
208D 4C               (      chkdisk.asm):00084                 INCA                                      ;     (D/256+1 FOR PARTIAL)
208E B7240B           (      chkdisk.asm):00085                 STA     >LNKSIZ                           ;SAVE IT
                      (      chkdisk.asm):00086         ;* FIRST, LOAD IN LINK SECTORS
2091 8E2410           (      chkdisk.asm):00087                 LDX     #WRKSPC                           ;PT TO WORK AREA
2094 170241           (      chkdisk.asm):00088                 LBSR    LDLINK                            ;LOAD LINK SECTS
2097 BF240C           (      chkdisk.asm):00089                 STX     >DATSPC                           ;SAVE PTR TO IT
209A 17023B           (      chkdisk.asm):00090                 LBSR    LDLINK                            ;READ AGAIN
                      (      chkdisk.asm):00091         ;* PERFORM ALLOCATION TABLE CHECK
209D B623FF           (      chkdisk.asm):00092                 LDA     >ALLOC                            ;DO ALLOCATION
20A0 102700F6         (      chkdisk.asm):00093                 LBEQ    NOALL                             ;NO
20A4 B62401           (      chkdisk.asm):00094                 LDA     >QUIET                            ;BEING QUIET?
20A7 2719             (      chkdisk.asm):00095                 BEQ     MAIN1                             ;YES
20A9 3F               (      chkdisk.asm):00096                 SWI
20AA 19               (      chkdisk.asm):00097                 FCB     25                                ;NEW LINE
20AB 436865636B696E67 (      chkdisk.asm):00098                 FCN     'Checking Allocation...'
     20416C6C6F636174
     696F6E2E2E2E00
                      (      chkdisk.asm):00099         ;* RELEASE DIRECTORY SECTORS
20C2                  (      chkdisk.asm):00100         MAIN1
20C2 CC0000           (      chkdisk.asm):00101                 LDD     #DIRLOC                           ;GET DIR LOC
20C5 170248           (      chkdisk.asm):00102                 LBSR    UNCHAIN                           ;RELEASE IT
                      (      chkdisk.asm):00103         ;* RELEASE LINK SECTORS
20C8 7C2406           (      chkdisk.asm):00104                 INC     >SECTYP                           ;INDICATE DOING LINKS
20CB CC0001           (      chkdisk.asm):00105                 LDD     #LNKLOC                           ;GET LINK LOCATION
20CE 17023F           (      chkdisk.asm):00106                 LBSR    UNCHAIN                           ;RELEASE LINKS
                      (      chkdisk.asm):00107         ;* READ DIRECTORY, RELEASING ALL FILE CHAINS
20D1 7C2406           (      chkdisk.asm):00108                 INC     >SECTYP                           ;ANDICATE DOING FILES
20D4 CC0000           (      chkdisk.asm):00109                 LDD     #DIRLOC                           ;PT TO DIRECTORY LOCATION
20D7                  (      chkdisk.asm):00110         MAIN2
20D7 FD2407           (      chkdisk.asm):00111                 STD     >DIRSEC                           ;SAVE PTR
20DA 3F               (      chkdisk.asm):00112                 SWI
20DB 54               (      chkdisk.asm):00113                 FCB     84                                ;READ WORK SECTOR
20DC 1F10             (      chkdisk.asm):00114                 TFR     X,D                               ;GET ADDRESS
20DE C30200           (      chkdisk.asm):00115                 ADDD    #512                              ;CALCULATE END
20E1 FD240E           (      chkdisk.asm):00116                 STD     >TEMP                             ;SAVE INDICATOR
20E4                  (      chkdisk.asm):00117         MAIN3
20E4 A684             (      chkdisk.asm):00118                 LDA     ,X                                ;FILE IN USE?
20E6 2706             (      chkdisk.asm):00119                 BEQ     MAIN4                             ;YES, RELEASE IT
                      (      chkdisk.asm):00120         ;* FILE EXISTS, RELEASE ITS LINKS
20E8 EC8813           (      chkdisk.asm):00121                 LDD     DDADR,X                           ;GET DISK ADDRESS
20EB 170222           (      chkdisk.asm):00122                 LBSR    UNCHAIN                           ;RELEASE SECTOR CHAIN
20EE                  (      chkdisk.asm):00123         MAIN4
20EE 308820           (      chkdisk.asm):00124                 LEAX    32,X                              ;NEXT ENTRY
20F1 BC240E           (      chkdisk.asm):00125                 CMPX    >TEMP                             ;OVER?
20F4 25EE             (      chkdisk.asm):00126                 BLO     MAIN3                             ;NO, KEEP LOOKING
20F6 BD22C4           (      chkdisk.asm):00127                 JSR     TQUIT                             ;TEST FOR EXIT
20F9 FC2407           (      chkdisk.asm):00128                 LDD     >DIRSEC                           ;GET CURRENT SECTOR
20FC 3F               (      chkdisk.asm):00129                 SWI
20FD 4D               (      chkdisk.asm):00130                 FCB     77                                ;LOOK UP ITS LINK
20FE 2706             (      chkdisk.asm):00131                 BEQ     MAIN5                             ;END OF FILE, STOP
2100 10830000         (      chkdisk.asm):00132                 CMPD    #0                                ;INSURE DIRECTORY IS NOT CORRUPT
2104 26D1             (      chkdisk.asm):00133                 BNE     MAIN2                             ;CONTINUE
                      (      chkdisk.asm):00134         ;* EXAMINE TABLE FOR ALLOCATED/UNUSED BLOCKS
2106                  (      chkdisk.asm):00135         MAIN5
2106 8E2410           (      chkdisk.asm):00136                 LDX     #WRKSPC                           ;PT TO WORK AREA
2109 FE240C           (      chkdisk.asm):00137                 LDU     >DATSPC                           ;GET DATA AREA
210C 108E0000         (      chkdisk.asm):00138                 LDY     #0                                ;START WITH SECTOR ZERO
2110 10BF240E         (      chkdisk.asm):00139                 STY     >TEMP                             ;ZERO COUNTERS
2114                  (      chkdisk.asm):00140         EXAM
2114 EC84             (      chkdisk.asm):00141                 LDD     ,X                                ;IS IT FREE
2116 274C             (      chkdisk.asm):00142                 BEQ     EXAM2                             ;YES
2118 7F2403           (      chkdisk.asm):00143                 CLR     >FLAG                             ;INDICATE CHANGED
211B 6FC4             (      chkdisk.asm):00144                 CLR     ,U                                ;ZERO LOW
211D 6F41             (      chkdisk.asm):00145                 CLR     1,U                               ;ZERO HIGH
211F FC2404           (      chkdisk.asm):00146                 LDD     >ERRORS                           ;GET TOTAL
2122 C30001           (      chkdisk.asm):00147                 ADDD    #1                                ;ADVANCE
2125 FD2404           (      chkdisk.asm):00148                 STD     >ERRORS                           ;RESAVE
2128 B6240E           (      chkdisk.asm):00149                 LDA     >TEMP                             ;GET FLAG
212B 2625             (      chkdisk.asm):00150                 BNE     EXAM1                             ;ALREADY SET
212D 7A240E           (      chkdisk.asm):00151                 DEC     >TEMP                             ;SET FLAG
2130 3F               (      chkdisk.asm):00152                 SWI
2131 19               (      chkdisk.asm):00153                 FCB     25
2132 426C6F636B732061 (      chkdisk.asm):00154                 FCN     'Blocks allocated, but not used:'
     6C6C6F6361746564
     2C20627574206E6F
     7420757365643A00
2152                  (      chkdisk.asm):00155         EXAM1
2152 3F               (      chkdisk.asm):00156                 SWI
2153 15               (      chkdisk.asm):00157                 FCB     21                                ;SPACE
2154 1F20             (      chkdisk.asm):00158                 TFR     Y,D                               ;GET SECTOR ID
2156 3F               (      chkdisk.asm):00159                 SWI
2157 1B               (      chkdisk.asm):00160                 FCB     27                                ;OUTPUT
2158 7C240F           (      chkdisk.asm):00161                 INC     >TEMP+1                           ;ADVANCE COUNTER
215B B6240F           (      chkdisk.asm):00162                 LDA     >TEMP+1                           ;GET VALUE
215E 8507             (      chkdisk.asm):00163                 BITA    #7                                ;PAST END?
2160 2602             (      chkdisk.asm):00164                 BNE     EXAM2                             ;NO
2162 3F               (      chkdisk.asm):00165                 SWI
2163 16               (      chkdisk.asm):00166                 FCB     22                                ;NEW LINE
2164                  (      chkdisk.asm):00167         EXAM2
2164 3121             (      chkdisk.asm):00168                 LEAY    1,Y                               ;NEXT SECTOR
2166 3002             (      chkdisk.asm):00169                 LEAX    2,X                               ;NEXT RAM LOC
2168 3342             (      chkdisk.asm):00170                 LEAU    2,U                               ;NEXT IN REAL SECTORS
216A 10BC2409         (      chkdisk.asm):00171                 CMPY    >DRVSIZ                           ;OVER?
216E 25A4             (      chkdisk.asm):00172                 BLO     EXAM                              ;NO, TRY AGAIN
2170 B6240F           (      chkdisk.asm):00173                 LDA     >TEMP+1                           ;GET COUNT
2173 8507             (      chkdisk.asm):00174                 BITA    #7                                ;NEW LINE
2175 2702             (      chkdisk.asm):00175                 BEQ     EXAM3                             ;NOT NESSARY
2177 3F               (      chkdisk.asm):00176                 SWI
2178 16               (      chkdisk.asm):00177                 FCB     22                                ;NEW LINE
                      (      chkdisk.asm):00178         ;* HAVE REPORTED THEM ALL
2179                  (      chkdisk.asm):00179         EXAM3
2179 B62401           (      chkdisk.asm):00180                 LDA     >QUIET
217C 271C             (      chkdisk.asm):00181                 BEQ     NOALL                             ;BE QUIET
217E FC2404           (      chkdisk.asm):00182                 LDD     >ERRORS                           ;GET TOTAL
2181 3F               (      chkdisk.asm):00183                 SWI
2182 1A               (      chkdisk.asm):00184                 FCB     26                                ;DISPLAY
2183 3F               (      chkdisk.asm):00185                 SWI
2184 19               (      chkdisk.asm):00186                 FCB     25                                ;MESSAGE
2185 20616C6C6F636174 (      chkdisk.asm):00187                 FCN     ' allocation error(s)'
     696F6E206572726F
     7228732900
219A                  (      chkdisk.asm):00188         NOALL
219A B62400           (      chkdisk.asm):00189                 LDA     >MEDIA                            ;DO MEDIA TEST?
219D 102700C9         (      chkdisk.asm):00190                 LBEQ    NOMED                             ;NO, NO MEDIA TEST
21A1 B62401           (      chkdisk.asm):00191                 LDA     >QUIET
21A4 2714             (      chkdisk.asm):00192                 BEQ     QUI2                              ;BE QUIET
21A6 3F               (      chkdisk.asm):00193                 SWI
21A7 19               (      chkdisk.asm):00194                 FCB     25                                ;MESSAGE
21A8 436865636B696E67 (      chkdisk.asm):00195                 FCN     'Checking Media...'
     204D656469612E2E
     2E00
21BA                  (      chkdisk.asm):00196         QUI2
21BA 4F               (      chkdisk.asm):00197                 CLRA
21BB 5F               (      chkdisk.asm):00198                 CLRB
21BC FD2404           (      chkdisk.asm):00199                 STD     >ERRORS                           ;CLEAR COUNT
21BF                  (      chkdisk.asm):00200         MED1
21BF FD2407           (      chkdisk.asm):00201                 STD     >DIRSEC                           ;SAVE SECTOR ID
21C2 8E2410           (      chkdisk.asm):00202                 LDX     #WRKSPC                           ;PT TO WORK AREA
21C5 3F               (      chkdisk.asm):00203                 SWI
21C6 5C               (      chkdisk.asm):00204                 FCB     92                                ;READ THE DISK
21C7 2774             (      chkdisk.asm):00205                 BEQ     MED3                              ;OK, DO NEXT
21C9 FC2404           (      chkdisk.asm):00206                 LDD     >ERRORS
21CC C30001           (      chkdisk.asm):00207                 ADDD    #1                                ;ADVANCE COUNT
21CF FD2404           (      chkdisk.asm):00208                 STD     >ERRORS
21D2 3F               (      chkdisk.asm):00209                 SWI
21D3 18               (      chkdisk.asm):00210                 FCB     24                                ;MESSAGE
21D4 4D65646961206572 (      chkdisk.asm):00211                 FCN     'Media error in sector '
     726F7220696E2073
     6563746F722000
21EB FC2407           (      chkdisk.asm):00212                 LDD     >DIRSEC                           ;GET SECTOR
21EE 3F               (      chkdisk.asm):00213                 SWI
21EF 1A               (      chkdisk.asm):00214                 FCB     26                                ;DISPLAY
21F0 FC2407           (      chkdisk.asm):00215                 LDD     >DIRSEC                           ;GET SECTOR BACK
21F3 BE240C           (      chkdisk.asm):00216                 LDX     >DATSPC                           ;ADVANCE
21F6 58               (      chkdisk.asm):00217                 LSLB
21F7 49               (      chkdisk.asm):00218                 ROLA                                      ;     X2 FOT TWO BYTE ENTRIES
21F8 308B             (      chkdisk.asm):00219                 LEAX    D,X                               ;ADVANCE TO IT
21FA EC84             (      chkdisk.asm):00220                 LDD     ,X                                ;GET IT
21FC 2616             (      chkdisk.asm):00221                 BNE     MED2                              ;ALLOCATED
21FE CCFFFF           (      chkdisk.asm):00222                 LDD     #$FFFF
2201 ED84             (      chkdisk.asm):00223                 STD     ,X                                ;MARK AS BUSY
2203 7F2403           (      chkdisk.asm):00224                 CLR     >FLAG                             ;INDICATE CHANGE
2206 3F               (      chkdisk.asm):00225                 SWI
2207 19               (      chkdisk.asm):00226                 FCB     25                                ;MESSAGE
2208 202D204D41524B45 (      chkdisk.asm):00227                 FCN     ' - MARKED'
     4400
2212 2029             (      chkdisk.asm):00228                 BRA     MED3                              ;CONTINUE
2214                  (      chkdisk.asm):00229         MED2
2214 3F               (      chkdisk.asm):00230                 SWI
2215 19               (      chkdisk.asm):00231                 FCB     25
2216 202D20203B2A203B (      chkdisk.asm):00232                 FCN     ' -  ;* ;* ;*ALREADY ALLOCATED ;* ;* ;*'
     2A203B2A414C5245
     41445920414C4C4F
     4341544544203B2A
     203B2A203B2A00
223D                  (      chkdisk.asm):00233         MED3
223D BD22C4           (      chkdisk.asm):00234                 JSR     TQUIT                             ;TEST FOR EXIT
2240 FC2407           (      chkdisk.asm):00235                 LDD     >DIRSEC                           ;GET SECTOR
2243 C30001           (      chkdisk.asm):00236                 ADDD    #1                                ;NEXT SECTOR
2246 10B32409         (      chkdisk.asm):00237                 CMPD    >DRVSIZ                           ;COMPARE WITH DISK
224A 1025FF71         (      chkdisk.asm):00238                 LBLO    MED1                              ;KEEP GOING
224E B62401           (      chkdisk.asm):00239                 LDA     >QUIET                            ;KEEPING QUIET?
2251 2717             (      chkdisk.asm):00240                 BEQ     NOMED                             ;YES
2253 FC2404           (      chkdisk.asm):00241                 LDD     >ERRORS
2256 3F               (      chkdisk.asm):00242                 SWI
2257 1A               (      chkdisk.asm):00243                 FCB     26
2258 3F               (      chkdisk.asm):00244                 SWI
2259 19               (      chkdisk.asm):00245                 FCB     25
225A 206D656469612065 (      chkdisk.asm):00246                 FCN     ' media error(s)'
     72726F7228732900
                      (      chkdisk.asm):00247         ;* PERFORM UPDATES IF NESSARY
226A                  (      chkdisk.asm):00248         NOMED
226A B62403           (      chkdisk.asm):00249                 LDA     >FLAG                             ;ANY CHANGES
226D 2652             (      chkdisk.asm):00250                 BNE     NOREB                             ;NO, SKIP IT
226F B62402           (      chkdisk.asm):00251                 LDA     >REBUILD        REBUILD AUTOMATICALLY?
2272 2728             (      chkdisk.asm):00252                 BEQ     GOREB                             ;YES
2274 3F               (      chkdisk.asm):00253                 SWI
2275 18               (      chkdisk.asm):00254                 FCB     24                                ;MESSAGE
2276 5772697465207570 (      chkdisk.asm):00255                 FCN     'Write updated link table?'
     6461746564206C69
     6E6B207461626C65
     3F00
2290 3F               (      chkdisk.asm):00256                 SWI
2291 22               (      chkdisk.asm):00257                 FCB     34                                ;GET CHAR
2292 3F               (      chkdisk.asm):00258                 SWI
2293 21               (      chkdisk.asm):00259                 FCB     33                                ;ECHO
2294 3F               (      chkdisk.asm):00260                 SWI
2295 16               (      chkdisk.asm):00261                 FCB     22                                ;NEW LINE
2296 845F             (      chkdisk.asm):00262                 ANDA    #$5F                              ;CONVERT
2298 8159             (      chkdisk.asm):00263                 CMPA    #'Y'                              ;YES?
229A 2625             (      chkdisk.asm):00264                 BNE     NOREB                             ;DON'T REBUILD
229C                  (      chkdisk.asm):00265         GOREB
229C BE240C           (      chkdisk.asm):00266                 LDX     >DATSPC                           ;PT TO AREA
229F 170052           (      chkdisk.asm):00267                 LBSR    SALINK                            ;SAVE IT OUT
22A2 B62401           (      chkdisk.asm):00268                 LDA     >QUIET
22A5 271A             (      chkdisk.asm):00269                 BEQ     NOREB
22A7 3F               (      chkdisk.asm):00270                 SWI
22A8 19               (      chkdisk.asm):00271                 FCB     25
22A9 4469736B20616C6C (      chkdisk.asm):00272                 FCN     'Disk allocation rebuilt'
     6F636174696F6E20
     72656275696C7400
22C1                  (      chkdisk.asm):00273         NOREB
22C1 4F               (      chkdisk.asm):00274                 CLRA                                      ;     ZERO RC
22C2 3F               (      chkdisk.asm):00275                 SWI
22C3 00               (      chkdisk.asm):00276                 FCB     0                                 ;BACK TO DOS
22C4                  (      chkdisk.asm):00277         TQUIT
22C4 3F               (      chkdisk.asm):00278                 SWI
22C5 23               (      chkdisk.asm):00279                 FCB     35
22C6 811B             (      chkdisk.asm):00280                 CMPA    #$1B
22C8 2627             (      chkdisk.asm):00281                 BNE     GORET
22CA 3F               (      chkdisk.asm):00282                 SWI
22CB 19               (      chkdisk.asm):00283                 FCB     25
22CC 3C41626F72746564 (      chkdisk.asm):00284                 FCN     '<Aborted>'
     3E00
22D6 20E9             (      chkdisk.asm):00285                 BRA     NOREB
                      (      chkdisk.asm):00286         ;*
                      (      chkdisk.asm):00287         ;* LOAD DISK LINK TABLE INTO MEMORY(X)
                      (      chkdisk.asm):00288         ;*
22D8                  (      chkdisk.asm):00289         LDLINK
22D8 B6240B           (      chkdisk.asm):00290                 LDA     >LNKSIZ                           ;GET SIZE
22DB B7240E           (      chkdisk.asm):00291                 STA     >TEMP                             ;SET UP
22DE CC0001           (      chkdisk.asm):00292                 LDD     #LNKLOC                           ;START OF LINK SECTORS
22E1                  (      chkdisk.asm):00293         LDLNK1
22E1 3F               (      chkdisk.asm):00294                 SWI
22E2 5C               (      chkdisk.asm):00295                 FCB     92                                ;READ SECTOR
22E3 260D             (      chkdisk.asm):00296                 BNE     ABORT1                            ;ERROR
22E5 C30001           (      chkdisk.asm):00297                 ADDD    #1                                ;ADVANCE SECTOR ID
22E8 30890200         (      chkdisk.asm):00298                 LEAX    512,X                             ;NEXT LOCATION
22EC 7A240E           (      chkdisk.asm):00299                 DEC     >TEMP                             ;TEST NUMBER
22EF 26F0             (      chkdisk.asm):00300                 BNE     LDLNK1                            ;LOAD EM ALL
22F1                  (      chkdisk.asm):00301         GORET
22F1 39               (      chkdisk.asm):00302                 RTS
22F2                  (      chkdisk.asm):00303         ABORT1
22F2 3F               (      chkdisk.asm):00304                 SWI
22F3 00               (      chkdisk.asm):00305                 FCB     0
                      (      chkdisk.asm):00306         ;*
                      (      chkdisk.asm):00307         ;* SAVE DISK LINK TABLE FROM MEMORY(X)
                      (      chkdisk.asm):00308         ;*
22F4                  (      chkdisk.asm):00309         SALINK
22F4 3F               (      chkdisk.asm):00310                 SWI
22F5 58               (      chkdisk.asm):00311                 FCB     88                                ;PURGE DOS WORK SECTOR
22F6 B6240B           (      chkdisk.asm):00312                 LDA     >LNKSIZ                           ;GET SIZE
22F9 B7240E           (      chkdisk.asm):00313                 STA     >TEMP                             ;SET UP
22FC CC0001           (      chkdisk.asm):00314                 LDD     #LNKLOC                           ;START OF LINK SECTORS
22FF                  (      chkdisk.asm):00315         SALNK1
22FF 3F               (      chkdisk.asm):00316                 SWI
2300 5D               (      chkdisk.asm):00317                 FCB     93                                ;READ SECTOR
2301 26EF             (      chkdisk.asm):00318                 BNE     ABORT1                            ;ERROR
2303 C30001           (      chkdisk.asm):00319                 ADDD    #1                                ;ADVANCE SECTOR ID
2306 30890200         (      chkdisk.asm):00320                 LEAX    512,X                             ;NEXT LOCATION
230A 7A240E           (      chkdisk.asm):00321                 DEC     >TEMP                             ;TEST NUMBER
230D 26F0             (      chkdisk.asm):00322                 BNE     SALNK1                            ;LOAD EM ALL
230F 39               (      chkdisk.asm):00323                 RTS
                      (      chkdisk.asm):00324         ;*
                      (      chkdisk.asm):00325         ;* UNCHAIN SECTORS FROM RAM TABLE
                      (      chkdisk.asm):00326         ;*
2310                  (      chkdisk.asm):00327         UNCHAIN
2310 3410             (      chkdisk.asm):00328                 PSHS    X                                 ;SAVE 'X'
2312                  (      chkdisk.asm):00329         UNC1
2312 58               (      chkdisk.asm):00330                 LSLB                                      ;     X 2
2313 49               (      chkdisk.asm):00331                 ROLA                                      ;     FOR ENTRIES
2314 C32410           (      chkdisk.asm):00332                 ADDD    #WRKSPC                           ;OFFSET TO WORKSPACE
2317 1F02             (      chkdisk.asm):00333                 TFR     D,Y                               ;COPY IT TO INDEX
2319 ECA4             (      chkdisk.asm):00334                 LDD     ,Y                                ;GET NEXT SECTOR
231B 2715             (      chkdisk.asm):00335                 BEQ     UNC2                              ;GO LOOSE SOMEHOW
231D 6FA4             (      chkdisk.asm):00336                 CLR     ,Y                                ;CLEAR LOW
231F 6F21             (      chkdisk.asm):00337                 CLR     1,Y                               ;CLEAR HIGH
2321 10B32409         (      chkdisk.asm):00338                 CMPD    >DRVSIZ                           ;IN RANGE?
2325 25EB             (      chkdisk.asm):00339                 BLO     UNC1                              ;YES, ITS OK
2327 1083FFFF         (      chkdisk.asm):00340                 CMPD    #$FFFF                            ;END OF FILE?
232B 276B             (      chkdisk.asm):00341                 BEQ     UNC7                              ;ALL IS OK
                      (      chkdisk.asm):00342         ;* LINK CHAIN POINTS BEYOND FILESYSTEM
232D CE23BD           (      chkdisk.asm):00343                 LDU     #OVRMSG                           ;PT TO MESSAGE
2330 2003             (      chkdisk.asm):00344                 BRA     UNC3                              ;AND CONTINUE
                      (      chkdisk.asm):00345         ;* LINK CHAIN ENDED WITH ZERO
2332                  (      chkdisk.asm):00346         UNC2
2332 CE239A           (      chkdisk.asm):00347                 LDU     #ZERMSG                           ;PT TO MESSAGE
2335                  (      chkdisk.asm):00348         UNC3
2335 FC2404           (      chkdisk.asm):00349                 LDD     >ERRORS
2338 C30001           (      chkdisk.asm):00350                 ADDD    #1                                ;ADVANCE ERROR COUNT
233B FD2404           (      chkdisk.asm):00351                 STD     >ERRORS
233E 3F               (      chkdisk.asm):00352                 SWI
233F 18               (      chkdisk.asm):00353                 FCB     24                                ;ERROR MESSAGE
2340 416C6C6F63617469 (      chkdisk.asm):00354                 FCN     'Allocation error in '
     6F6E206572726F72
     20696E2000
2355 B62406           (      chkdisk.asm):00355                 LDA     >SECTYP                           ;GET SECTOR TYPE
2358 260E             (      chkdisk.asm):00356                 BNE     UNC4                              ;NO, NOT DIRECTORY
235A 3F               (      chkdisk.asm):00357                 SWI
235B 18               (      chkdisk.asm):00358                 FCB     24
235C 4449524543544F52 (      chkdisk.asm):00359                 FCN     'DIRECTORY'
     5900
2366 2014             (      chkdisk.asm):00360                 BRA     UNC6
2368                  (      chkdisk.asm):00361         UNC4
2368 4A               (      chkdisk.asm):00362                 DECA                                      ;     IS IT LINKS?
2369 260F             (      chkdisk.asm):00363                 BNE     UNC5                              ;NO, NOT LINKS.
236B 3F               (      chkdisk.asm):00364                 SWI
236C 18               (      chkdisk.asm):00365                 FCB     24
236D 4C494E4B20544142 (      chkdisk.asm):00366                 FCN     'LINK TABLE'
     4C4500
2378 2002             (      chkdisk.asm):00367                 BRA     UNC6
237A                  (      chkdisk.asm):00368         UNC5
237A 3F               (      chkdisk.asm):00369                 SWI
237B 1F               (      chkdisk.asm):00370                 FCB     31                                ;DISPLAY FILENAME
237C                  (      chkdisk.asm):00371         UNC6
237C 3F               (      chkdisk.asm):00372                 SWI
237D 18               (      chkdisk.asm):00373                 FCB     24                                ;DISPLAY MESSAGE
237E 2C20626C6F636B20 (      chkdisk.asm):00374                 FCN     ', block '
     00
2387 1F20             (      chkdisk.asm):00375                 TFR     Y,D                               ;GET BLOCK ID
2389 832410           (      chkdisk.asm):00376                 SUBD    #WRKSPC                           ;CONVERT
238C 44               (      chkdisk.asm):00377                 LSRA                                      ;     /2
238D 56               (      chkdisk.asm):00378                 RORB                                      ;     FOR ACTUAL ID
238E 3F               (      chkdisk.asm):00379                 SWI
238F 1A               (      chkdisk.asm):00380                 FCB     26                                ;OUTPUT IN DECIMAL
2390 3F               (      chkdisk.asm):00381                 SWI
2391 16               (      chkdisk.asm):00382                 FCB     22                                ;NEW LINE
2392 1F31             (      chkdisk.asm):00383                 TFR     U,X                               ;GET PTR TO MESSAGE
2394 3F               (      chkdisk.asm):00384                 SWI
2395 17               (      chkdisk.asm):00385                 FCB     23                                ;DISPLAY MESSAGE
2396 3F               (      chkdisk.asm):00386                 SWI
2397 16               (      chkdisk.asm):00387                 FCB     22                                ;NEW LINE
2398                  (      chkdisk.asm):00388         UNC7
2398 3590             (      chkdisk.asm):00389                 PULS    X,PC                              ;RESTORE & RETURN
239A                  (      chkdisk.asm):00390         ZERMSG
239A 436861696E20656E (      chkdisk.asm):00391                 FCN     'Chain ends in unallocated (0) link'
     647320696E20756E
     616C6C6F63617465
     6420283029206C69
     6E6B00
23BD                  (      chkdisk.asm):00392         OVRMSG
23BD 4C696E6B20657863 (      chkdisk.asm):00393                 FCN     'Link exceeds filesystem bounds'
     656564732066696C
     6573797374656D20
     626F756E647300
                      (      chkdisk.asm):00394         ;* QUALIFIER TABLES
23DC                  (      chkdisk.asm):00395         QTABLE
23DC 84               (      chkdisk.asm):00396                 FCB     $84
23DD 2F4E4F414C4C4F43 (      chkdisk.asm):00397                 FCC     '/NOALLOC'
23E5 84               (      chkdisk.asm):00398                 FCB     $84
23E6 2F4E4F4D45444941 (      chkdisk.asm):00399                 FCC     '/NOMEDIA'
23EE 82               (      chkdisk.asm):00400                 FCB     $82
23EF 2F5155494554     (      chkdisk.asm):00401                 FCC     '/QUIET'
23F5 82               (      chkdisk.asm):00402                 FCB     $82
23F6 2F52454255494C44 (      chkdisk.asm):00403                 FCC     '/REBUILD'
23FE 80               (      chkdisk.asm):00404                 FCB     $80
     0004             (      chkdisk.asm):00405         QMAX            = 4                               ;# QUALIFIERS
     23FF             (      chkdisk.asm):00406         QFLAGS          = *
23FF                  (      chkdisk.asm):00407         ALLOC
23FF FF               (      chkdisk.asm):00408                 FCB     $FF                               ;ALLOCATION TEST
2400                  (      chkdisk.asm):00409         MEDIA
2400 FF               (      chkdisk.asm):00410                 FCB     $FF                               ;MEDIA TEST
2401                  (      chkdisk.asm):00411         QUIET
2401 FF               (      chkdisk.asm):00412                 FCB     $FF                               ;QUIET MODE
2402                  (      chkdisk.asm):00413         REBUILD
2402 FF               (      chkdisk.asm):00414                 FCB     $FF                               ;REBUILD MAP
                      (      chkdisk.asm):00415         ;* MISC LOCAL VARIABLES
2403                  (      chkdisk.asm):00416         FLAG
2403 FF               (      chkdisk.asm):00417                 FCB     $FF                               ;INDICATES CHANGED SECTOR
2404                  (      chkdisk.asm):00418         ERRORS
2404 0000             (      chkdisk.asm):00419                 FDB     0                                 ;ERROR COUNT FLAG
2406                  (      chkdisk.asm):00420         SECTYP
2406 00               (      chkdisk.asm):00421                 FCB     0                                 ;SECTOR TYPE BEING RELEASED
2407                  (      chkdisk.asm):00422         DIRSEC
2407                  (      chkdisk.asm):00423                 RMB     2                                 ;CURRENT DIRECTORY SECTOR
2409                  (      chkdisk.asm):00424         DRVSIZ
2409                  (      chkdisk.asm):00425                 RMB     2                                 ;DISK SIZE (IN SECTORS)
240B                  (      chkdisk.asm):00426         LNKSIZ
240B                  (      chkdisk.asm):00427                 RMB     1                                 ;SIZE OF LINK MAP (IN SECTORS)
240C                  (      chkdisk.asm):00428         DATSPC
240C                  (      chkdisk.asm):00429                 RMB     2                                 ;PTR TO DATA RAM
240E                  (      chkdisk.asm):00430         TEMP
240E                  (      chkdisk.asm):00431                 RMB     2                                 ;TEMPORARY STORAGE
                      (      chkdisk.asm):00432         ;* WORK AREA
     2410             (      chkdisk.asm):00433         WRKSPC          = *

Symbol Table:
[ G] ABORT                            203B
[ G] ABORT1                           22F2
[ G] ALLOC                            23FF
[ G] CHKDISK                          2000
[ G] DATSPC                           240C
[ G] DATTR                            0017
[ G] DDADR                            0013
[ G] DIRLOC                           0000
[ G] DIRSEC                           2407
[ G] DNAME                            0008
[ G] DPREFIX                          0000
[ G] DRADR                            0015
[ G] DRVSIZ                           2409
[ G] DTYPE                            0010
[ G] ERRORS                           2404
[ G] EXAM                             2114
[ G] EXAM1                            2152
[ G] EXAM2                            2164
[ G] EXAM3                            2179
[ G] FLAG                             2403
[ G] GOREB                            229C
[ G] GORET                            22F1
[ G] LDLINK                           22D8
[ G] LDLNK1                           22E1
[ G] LNKLOC                           0001
[ G] LNKSIZ                           240B
[ G] MAIN                             207D
[ G] MAIN1                            20C2
[ G] MAIN2                            20D7
[ G] MAIN3                            20E4
[ G] MAIN4                            20EE
[ G] MAIN5                            2106
[ G] MED1                             21BF
[ G] MED2                             2214
[ G] MED3                             223D
[ G] MEDIA                            2400
[ G] NOALL                            219A
[ G] NOMED                            226A
[ G] NOREB                            22C1
[ G] OSEND                            DBFF
[ G] OSRAM                            2000
[ G] OSUTIL                           D000
[ G] OVRMSG                           23BD
[ G] QERR                             2053
[ G] QERR1                            206B
[ G] QERR2                            2075
[ G] QFLAGS                           23FF
[ G] QMAX                             0004
[ G] QTABLE                           23DC
[ G] QUAL                             203D
[ G] QUI2                             21BA
[ G] QUIET                            2401
[ G] REBUILD                          2402
[ G] SALINK                           22F4
[ G] SALNK1                           22FF
[ G] SECTYP                           2406
[ G] TEMP                             240E
[ G] TQUIT                            22C4
[ G] UNC1                             2312
[ G] UNC2                             2332
[ G] UNC3                             2335
[ G] UNC4                             2368
[ G] UNC5                             237A
[ G] UNC6                             237C
[ G] UNC7                             2398
[ G] UNCHAIN                          2310
[ G] WRKSPC                           2410
[ G] ZERMSG                           239A
