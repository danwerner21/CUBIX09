                      (        ch375.asm):00001         ;*
                      (        ch375.asm):00002         ;* CH375 Test
                      (        ch375.asm):00003         ;*
                      (        ch375.asm):00004         ;*
                      (        ch375.asm):00005         ;*
                      (        ch375.asm):00006         ;*
     2000             (        ch375.asm):00007         OSRAM           = $2000                           ;APPLICATION RAM AREA
     DBFF             (        ch375.asm):00008         OSEND           = $DBFF                           ;END OF GENERAL RAM
     D000             (        ch375.asm):00009         OSUTIL          = $D000                           ;UTILITY ADDRESS SPACE
     0016             (        ch375.asm):00010         PAGSIZ          = 22                              ;PAGE SIZE
     001B             (        ch375.asm):00011         ESCCHR          = $1B                             ;ESCAPE CHARACTER
     0009             (        ch375.asm):00012         TAB             = $09                             ;TAB CHARACTER
     000D             (        ch375.asm):00013         CR              = $0D                             ;CARRIAGE RETURN
     000A             (        ch375.asm):00014         LF              = $0A                             ;LINE-FEED
     5000             (        ch375.asm):00015         HSTBUF          = $5000
     0050             (        ch375.asm):00016         CURRENTSEC      = $50
     0051             (        ch375.asm):00017         CURRENTCYL      = $51
     0052             (        ch375.asm):00018         CURRENTSLICE    = $52
                      (        ch375.asm):00019         
                      (        ch375.asm):00020         ;*
                      (        ch375.asm):00021                 ORG     OSUTIL                            ;DOS UTILITY RUN AREA
D000                  (        ch375.asm):00022         CH375:
D000 3F               (        ch375.asm):00023                 SWI
D001 19               (        ch375.asm):00024                 FCB     25                                ;DISPLAY MESSAGE
D002 5445535420434833 (        ch375.asm):00025                 FCN     'TEST CH375 USB CARD'
     3735205553422043
     41524400
D016 3F               (        ch375.asm):00026                 SWI
D017 16               (        ch375.asm):00027                 FCB     22
D018 BDD0BF           (        ch375.asm):00028                 JSR     CH375INIT
D01B 2573             (        ch375.asm):00029                 BCS     >
                      (        ch375.asm):00030         
D01D 8601             (        ch375.asm):00031                 LDA     #$01
D01F 9750             (        ch375.asm):00032                 STA     CURRENTSEC
D021 9751             (        ch375.asm):00033                 STA     CURRENTCYL
D023 9752             (        ch375.asm):00034                 STA     CURRENTSLICE
                      (        ch375.asm):00035         
D025 86AA             (        ch375.asm):00036                 LDA     #$AA
D027 BDD094           (        ch375.asm):00037                 JSR     FILLSEC
D02A 3F               (        ch375.asm):00038                 SWI
D02B 19               (        ch375.asm):00039                 FCB     25                                ;DISPLAY MESSAGE
D02C 52454144204F4E45 (        ch375.asm):00040                 FCN     'READ ONE:'
     3A00
D036 3F               (        ch375.asm):00041                 SWI
D037 16               (        ch375.asm):00042                 FCB     22
D038 BDD298           (        ch375.asm):00043                 JSR     CH_READSEC
D03B BDD09F           (        ch375.asm):00044                 JSR     DUMPSEC
                      (        ch375.asm):00045         
D03E 86AA             (        ch375.asm):00046                 LDA     #$AA
D040 BDD094           (        ch375.asm):00047                 JSR     FILLSEC
D043 3F               (        ch375.asm):00048                 SWI
D044 19               (        ch375.asm):00049                 FCB     25                                ;DISPLAY MESSAGE
D045 524541442054574F (        ch375.asm):00050                 FCN     'READ TWO:'
     3A00
D04F 3F               (        ch375.asm):00051                 SWI
D050 16               (        ch375.asm):00052                 FCB     22
D051 BDD298           (        ch375.asm):00053                 JSR     CH_READSEC
D054 BDD09F           (        ch375.asm):00054                 JSR     DUMPSEC
                      (        ch375.asm):00055         
                      (        ch375.asm):00056         
D057 8655             (        ch375.asm):00057                 LDA     #$55
D059 BDD094           (        ch375.asm):00058                 JSR     FILLSEC
D05C 3F               (        ch375.asm):00059                 SWI
D05D 19               (        ch375.asm):00060                 FCB     25                                ;DISPLAY MESSAGE
D05E 5752495445204F4E (        ch375.asm):00061                 FCN     'WRITE ONE:'
     453A00
D069 3F               (        ch375.asm):00062                 SWI
D06A 16               (        ch375.asm):00063                 FCB     22
D06B BDD2D3           (        ch375.asm):00064                 JSR     CH_WRITESEC
D06E BDD09F           (        ch375.asm):00065                 JSR     DUMPSEC
                      (        ch375.asm):00066         
                      (        ch375.asm):00067         
D071 86AA             (        ch375.asm):00068                 LDA     #$AA
D073 BDD094           (        ch375.asm):00069                 JSR     FILLSEC
D076 3F               (        ch375.asm):00070                 SWI
D077 19               (        ch375.asm):00071                 FCB     25                                ;DISPLAY MESSAGE
D078 5245414420544852 (        ch375.asm):00072                 FCN     'READ THREE:'
     45453A00
D084 3F               (        ch375.asm):00073                 SWI
D085 16               (        ch375.asm):00074                 FCB     22
D086 BDD298           (        ch375.asm):00075                 JSR     CH_READSEC
D089 BDD09F           (        ch375.asm):00076                 JSR     DUMPSEC
                      (        ch375.asm):00077         
D08C CC0000           (        ch375.asm):00078                 LDD     #0000
D08F 39               (        ch375.asm):00079                 RTS
                      (        ch375.asm):00080         !
D090 CCFFFF           (        ch375.asm):00081                 LDD     #$FFFF
D093 39               (        ch375.asm):00082                 RTS
                      (        ch375.asm):00083         
D094                  (        ch375.asm):00084         FILLSEC:
D094 8E5000           (        ch375.asm):00085                 LDX     #HSTBUF
D097                  (        ch375.asm):00086         FILLSEC1:
D097 A780             (        ch375.asm):00087                 STA     ,X+
D099 8C5201           (        ch375.asm):00088                 CPX     #HSTBUF+$201
D09C 26F9             (        ch375.asm):00089                 BNE     FILLSEC1
D09E 39               (        ch375.asm):00090                 RTS
                      (        ch375.asm):00091         
                      (        ch375.asm):00092         
D09F                  (        ch375.asm):00093         DUMPSEC:
D09F 8E5000           (        ch375.asm):00094                 LDX     #HSTBUF
D0A2                  (        ch375.asm):00095         DUMPSEC1:
D0A2 1F10             (        ch375.asm):00096                 TFR     X,D
D0A4 3F               (        ch375.asm):00097                 SWI
D0A5 1B               (        ch375.asm):00098                 FCB     27
D0A6 863A             (        ch375.asm):00099                 LDA     #':'
D0A8 3F               (        ch375.asm):00100                 SWI
D0A9 21               (        ch375.asm):00101                 FCB     33
D0AA C610             (        ch375.asm):00102                 LDB     #16
D0AC                  (        ch375.asm):00103         DUMPSEC2:
D0AC A680             (        ch375.asm):00104                 LDA     ,X+
D0AE 3F               (        ch375.asm):00105                 SWI
D0AF 1C               (        ch375.asm):00106                 FCB     28
D0B0 3F               (        ch375.asm):00107                 SWI
D0B1 15               (        ch375.asm):00108                 FCB     21
D0B2 5A               (        ch375.asm):00109                 DECB
D0B3 26F7             (        ch375.asm):00110                 BNE     DUMPSEC2
D0B5 3F               (        ch375.asm):00111                 SWI
D0B6 16               (        ch375.asm):00112                 FCB     22
D0B7 8C5200           (        ch375.asm):00113                 CPX     #HSTBUF+$200
D0BA 25E6             (        ch375.asm):00114                 BLO     DUMPSEC1
D0BC 3F               (        ch375.asm):00115                 SWI
D0BD 16               (        ch375.asm):00116                 FCB     22
D0BE 39               (        ch375.asm):00117                 RTS
                      (        ch375.asm):00118         
                      (        ch375.asm):00119         
                      (        ch375.asm):00120         ;--------------------------------------------------------------------------------------------------------------------
                      (        ch375.asm):00121         ; DRIVER FOLLOWS
                      (        ch375.asm):00122         ;--------------------------------------------------------------------------------------------------------------------
                      (        ch375.asm):00123         ; CH375 HARDWARE ADDRESS
     1260             (        ch375.asm):00124         CH0BASE         = $1260
     1260             (        ch375.asm):00125         CH0DATA         = CH0BASE
     1261             (        ch375.asm):00126         CH0COMMAND      = CH0BASE+1
                      (        ch375.asm):00127         
                      (        ch375.asm):00128         ;
                      (        ch375.asm):00129         ; CH375/376 COMMANDS
                      (        ch375.asm):00130         ;
     0001             (        ch375.asm):00131         CH_CMD_VER      = $01                             ; GET IC VER
     0005             (        ch375.asm):00132         CH_CMD_RESET    = $05                             ; FULL CH37X RESET
     0006             (        ch375.asm):00133         CH_CMD_EXIST    = $06                             ; CHECK EXISTS
     000A             (        ch375.asm):00134         CH_CMD_MAXLUN   = $0A                             ; GET MAX LUN NUMBER
     000B             (        ch375.asm):00135         CH_CMD_PKTSEC   = $0B                             ; SET PACKETS PER SECTOR
     000B             (        ch375.asm):00136         CH_CMD_SETRETRY = $0B                             ; SET RETRIES
     0015             (        ch375.asm):00137         CH_CMD_MODE     = $15                             ; SET USB MODE
     0016             (        ch375.asm):00138         CH_CMD_TSTCON   = $16                             ; TEST CONNECT
     0017             (        ch375.asm):00139         CH_CMD_ABRTNAK  = $17                             ; ABORT DEVICE NAK RETRIES
     0022             (        ch375.asm):00140         CH_CMD_STAT     = $22                             ; GET STATUS
     0028             (        ch375.asm):00141         CH_CMD_RD5      = $28                             ; READ USB DATA (375)
     002B             (        ch375.asm):00142         CH_CMD_WR5      = $2B                             ; WRITE USB DATA (375)
     0031             (        ch375.asm):00143         CH_CMD_DSKMNT   = $31                             ; DISK MOUNT
     0039             (        ch375.asm):00144         CH_CMD_BYTE_LOC = $39                             ; BYTE LOCATE
     003A             (        ch375.asm):00145         CH_CMD_BYTERD   = $3A                             ; BYTE READ
     003B             (        ch375.asm):00146         CH_CMD_BYTERDGO = $3B                             ; BYTE READ GO
     003C             (        ch375.asm):00147         CH_CMD_BYTEWR   = $3C                             ; BYTE WRITE
     003D             (        ch375.asm):00148         CH_CMD_BYTEWRGO = $3D                             ; BYTE WRITE GO
     003E             (        ch375.asm):00149         CH_CMD_DSKCAP   = $3E                             ; DISK CAPACITY
     004D             (        ch375.asm):00150         CH_CMD_AUTOSET  = $4D                             ; USB AUTO SETUP
     0051             (        ch375.asm):00151         CH_CMD_DSKINIT  = $51                             ; DISK INIT
     0052             (        ch375.asm):00152         CH_CMD_DSKRES   = $52                             ; DISK RESET
     0053             (        ch375.asm):00153         CH_CMD_DSKSIZ   = $53                             ; DISK SIZE
     0054             (        ch375.asm):00154         CH_CMD_DSKRD    = $54                             ; DISK READ
     0055             (        ch375.asm):00155         CH_CMD_DSKRDGO  = $55                             ; CONTINUE DISK READ
     0056             (        ch375.asm):00156         CH_CMD_DSKWR    = $56                             ; DISK WRITE
     0057             (        ch375.asm):00157         CH_CMD_DSKWRGO  = $57                             ; CONTINUE DISK WRITE
     0058             (        ch375.asm):00158         CH_CMD_DSKINQ   = $58                             ; DISK INQUIRY
     0059             (        ch375.asm):00159         CH_CMD_DSKRDY   = $59                             ; DISK READY
                      (        ch375.asm):00160         
D0BF                  (        ch375.asm):00161         CH375INIT:
D0BF BDD144           (        ch375.asm):00162                 JSR     CH_DETECT
D0C2 2665             (        ch375.asm):00163                 BNE     NOTDETECTED
                      (        ch375.asm):00164         
D0C4 3F               (        ch375.asm):00165                 SWI
D0C5 19               (        ch375.asm):00166                 FCB     25                                ;DISPLAY MESSAGE
D0C6 2020434833373520 (        ch375.asm):00167                 FCN     '  CH375 DETECTED.'
     4445544543544544
     2E00
                      (        ch375.asm):00168         
D0D8 BDD1E0           (        ch375.asm):00169                 JSR     CH_DISKINIT
D0DB 2532             (        ch375.asm):00170                 BCS     >
                      (        ch375.asm):00171         
D0DD 3F               (        ch375.asm):00172                 SWI
D0DE 18               (        ch375.asm):00173                 FCB     24                                ;DISPLAY MESSAGE
D0DF 2020434833373520 (        ch375.asm):00174                 FCN     '  CH375 MEDIA SIZE: 0x'
     4D45444941205349
     5A453A20307800
                      (        ch375.asm):00175         
D0F6 FC5000           (        ch375.asm):00176                 LDD     HSTBUF
D0F9 3F               (        ch375.asm):00177                 SWI
D0FA 1B               (        ch375.asm):00178                 FCB     27
                      (        ch375.asm):00179         
D0FB FC5002           (        ch375.asm):00180                 LDD     HSTBUF+2
D0FE 3F               (        ch375.asm):00181                 SWI
D0FF 1B               (        ch375.asm):00182                 FCB     27
                      (        ch375.asm):00183         
D100 3F               (        ch375.asm):00184                 SWI
D101 19               (        ch375.asm):00185                 FCB     25                                ;DISPLAY MESSAGE
D102 20534543544F5253 (        ch375.asm):00186                 FCN     ' SECTORS.'
     2E00
D10C 1CFE             (        ch375.asm):00187                 CLC
D10E 39               (        ch375.asm):00188                 RTS
                      (        ch375.asm):00189         !
D10F 3F               (        ch375.asm):00190                 SWI
D110 19               (        ch375.asm):00191                 FCB     25                                ;DISPLAY MESSAGE
D111 2020434833373520 (        ch375.asm):00192                 FCN     '  CH375 MEDIA ERROR.'
     4D45444941204552
     524F522E00
D126 1A01             (        ch375.asm):00193                 SEC
D128 39               (        ch375.asm):00194                 RTS
D129                  (        ch375.asm):00195         NOTDETECTED:
D129 3F               (        ch375.asm):00196                 SWI
D12A 19               (        ch375.asm):00197                 FCB     25                                ;DISPLAY MESSAGE
D12B 2020434833373520 (        ch375.asm):00198                 FCN     '  CH375 NOT DETECTED.'
     4E4F542044455445
     435445442E00
D141 1A01             (        ch375.asm):00199                 SEC
D143 39               (        ch375.asm):00200                 RTS
                      (        ch375.asm):00201         
D144                  (        ch375.asm):00202         CH_DETECT:
D144 3F               (        ch375.asm):00203                 SWI
D145 19               (        ch375.asm):00204                 FCB     25                                ;DISPLAY MESSAGE
D146 4348333735205553 (        ch375.asm):00205                 FCN     'CH375 USB:'
     423A00
D151 3F               (        ch375.asm):00206                 SWI
D152 18               (        ch375.asm):00207                 FCB     24                                ;DISPLAY MESSAGE
D153 2020494F3D307800 (        ch375.asm):00208                 FCN     '  IO=0x'
D15B CC1260           (        ch375.asm):00209                 LDD     #CH0BASE
D15E 3F               (        ch375.asm):00210                 SWI
D15F 1B               (        ch375.asm):00211                 FCB     27
D160 BDD19B           (        ch375.asm):00212                 JSR     CH_RESET
                      (        ch375.asm):00213         
D163                  (        ch375.asm):00214         CH_DETECT1:
D163 8606             (        ch375.asm):00215                 LDA     #CH_CMD_EXIST                     ; LOAD COMMAND
D165 BDD176           (        ch375.asm):00216                 JSR     CH_CMD                            ; SEND COMMAND
D168 86AA             (        ch375.asm):00217                 LDA     #$AA                              ; LOAD CHECK PATTERN
D16A BDD185           (        ch375.asm):00218                 JSR     CH_WR                             ; SEND IT
D16D BDD189           (        ch375.asm):00219                 JSR     CH_NAP                            ; SMALL DELAY
D170 BDD181           (        ch375.asm):00220                 JSR     CH_RD                             ; GET ECHO
D173 8155             (        ch375.asm):00221                 CMPA    #$55                              ; SHOULD BE INVERTED
D175 39               (        ch375.asm):00222                 RTS                                       ; RETURN
                      (        ch375.asm):00223         
D176                  (        ch375.asm):00224         CH_CMD:
D176 B71261           (        ch375.asm):00225                 STA     CH0COMMAND                        ; SEND COMMAND
D179 BDD189           (        ch375.asm):00226                 JSR     CH_NAP                            ;
D17C 39               (        ch375.asm):00227                 RTS
                      (        ch375.asm):00228         ;
                      (        ch375.asm):00229         ; GET STATUS
                      (        ch375.asm):00230         ;
D17D                  (        ch375.asm):00231         CH_STAT:
D17D B61261           (        ch375.asm):00232                 LDA     CH0COMMAND                        ; READ STATUS
D180 39               (        ch375.asm):00233                 RTS
                      (        ch375.asm):00234         ;
                      (        ch375.asm):00235         ; READ A BYTE FROM DATA PORT
                      (        ch375.asm):00236         ;
D181                  (        ch375.asm):00237         CH_RD:
D181 B61260           (        ch375.asm):00238                 LDA     CH0DATA                           ; READ BYTE
D184 39               (        ch375.asm):00239                 RTS
                      (        ch375.asm):00240         ;
                      (        ch375.asm):00241         ; WRITE A BYTE TO DATA PORT
                      (        ch375.asm):00242         ;
D185                  (        ch375.asm):00243         CH_WR:
D185 B71260           (        ch375.asm):00244                 STA     CH0DATA                           ; WRITE BYTE
D188 39               (        ch375.asm):00245                 RTS
                      (        ch375.asm):00246         
D189                  (        ch375.asm):00247         CH_NAP:
D189 12               (        ch375.asm):00248                 NOP
D18A 12               (        ch375.asm):00249                 NOP
D18B 12               (        ch375.asm):00250                 NOP
D18C 12               (        ch375.asm):00251                 NOP
D18D 12               (        ch375.asm):00252                 NOP
D18E 12               (        ch375.asm):00253                 NOP
D18F 39               (        ch375.asm):00254                 RTS
D190 3410             (        ch375.asm):00255                 PSHS    X
D192 8E0500           (        ch375.asm):00256                 LDX     #$500
                      (        ch375.asm):00257         !
D195 301F             (        ch375.asm):00258                 DEX
D197 26FC             (        ch375.asm):00259                 BNE     <
D199 3590             (        ch375.asm):00260                 PULS    X,PC
                      (        ch375.asm):00261         
D19B                  (        ch375.asm):00262         CH_RESET:
D19B 3430             (        ch375.asm):00263                 PSHS    X,Y
D19D 8605             (        ch375.asm):00264                 LDA     #CH_CMD_RESET
D19F BDD176           (        ch375.asm):00265                 JSR     CH_CMD                            ; SEND COMMAND
D1A2 108E000F         (        ch375.asm):00266                 LDY     #$0F
D1A6                  (        ch375.asm):00267         CH_RES1:
D1A6 8EFFFF           (        ch375.asm):00268                 LDX     #$FFFF
                      (        ch375.asm):00269         !
D1A9 301F             (        ch375.asm):00270                 DEX
D1AB 26FC             (        ch375.asm):00271                 BNE     <
D1AD 313F             (        ch375.asm):00272                 DEY
D1AF 26F5             (        ch375.asm):00273                 BNE     CH_RES1
D1B1 35B0             (        ch375.asm):00274                 PULS    X,Y,PC
                      (        ch375.asm):00275         
                      (        ch375.asm):00276         
                      (        ch375.asm):00277         ;
                      (        ch375.asm):00278         ; POLL WAITING FOR INTERRUPT
                      (        ch375.asm):00279         ;
D1B3                  (        ch375.asm):00280         CH_POLL:
D1B3 3434             (        ch375.asm):00281                 PSHS    B,X,Y
D1B5 108E0030         (        ch375.asm):00282                 LDY     #$0030
D1B9                  (        ch375.asm):00283         CH_POLL0:
D1B9 8E8000           (        ch375.asm):00284                 LDX     #$8000                            ; PRIMARY LOOP COUNTER
D1BC                  (        ch375.asm):00285         CH_POLL1:
D1BC BDD17D           (        ch375.asm):00286                 JSR     CH_STAT                           ; GET INT STATUS
D1BF 8480             (        ch375.asm):00287                 ANDA    #%10000000
D1C1 270D             (        ch375.asm):00288                 BEQ     CH_POLL2                          ; CHECK BIT
D1C3 301F             (        ch375.asm):00289                 DEX
D1C5 26F5             (        ch375.asm):00290                 BNE     CH_POLL1                          ; INNER LOOP AS NEEDED
D1C7 313F             (        ch375.asm):00291                 DEY
D1C9 26EE             (        ch375.asm):00292                 BNE     CH_POLL0                          ; OUTER LOOP AS NEEDED
D1CB 3534             (        ch375.asm):00293                 PULS    B,X,Y
D1CD 1A01             (        ch375.asm):00294                 SEC
D1CF 39               (        ch375.asm):00295                 RTS                                       ; AND RETURN
D1D0                  (        ch375.asm):00296         CH_POLL2:
D1D0 8622             (        ch375.asm):00297                 LDA     #CH_CMD_STAT                      ; GET STATUS
D1D2 BDD176           (        ch375.asm):00298                 JSR     CH_CMD                            ; SEND IT
D1D5 BDD189           (        ch375.asm):00299                 JSR     CH_NAP                            ; SMALL DELAY
D1D8 BDD181           (        ch375.asm):00300                 JSR     CH_RD                             ; GET RESULT
D1DB 3534             (        ch375.asm):00301                 PULS    B,X,Y
D1DD 1CFE             (        ch375.asm):00302                 CLC
D1DF 39               (        ch375.asm):00303                 RTS                                       ; AND RETURN
                      (        ch375.asm):00304         
                      (        ch375.asm):00305         
                      (        ch375.asm):00306         
D1E0                  (        ch375.asm):00307         CH_DISKINIT:
D1E0 3430             (        ch375.asm):00308                 PSHS    X,Y
                      (        ch375.asm):00309         
                      (        ch375.asm):00310         ; RESET THE BUS
D1E2 8615             (        ch375.asm):00311                 LDA     #CH_CMD_MODE                      ; SET MODE COMMAND
D1E4 BDD176           (        ch375.asm):00312                 JSR     CH_CMD                            ; SEND IT
D1E7 8607             (        ch375.asm):00313                 LDA     #7                                ; RESET BUS
D1E9 BDD185           (        ch375.asm):00314                 JSR     CH_WR                             ; SEND IT
D1EC BDD189           (        ch375.asm):00315                 JSR     CH_NAP                            ; SMALL WAIT
D1EF BDD181           (        ch375.asm):00316                 JSR     CH_RD                             ; GET RESULT
D1F2 BDD189           (        ch375.asm):00317                 JSR     CH_NAP                            ; SMALL WAIT
                      (        ch375.asm):00318         ;
                      (        ch375.asm):00319         ; ACTIVATE USB MODE
D1F5 8615             (        ch375.asm):00320                 LDA     #CH_CMD_MODE                      ; SET MODE COMMAND
D1F7 BDD176           (        ch375.asm):00321                 JSR     CH_CMD                            ; SEND IT
D1FA 8606             (        ch375.asm):00322                 LDA     #6                                ; USB ENABLED, SEND SOF
D1FC BDD185           (        ch375.asm):00323                 JSR     CH_WR                             ; SEND IT
D1FF BDD189           (        ch375.asm):00324                 JSR     CH_NAP                            ; SMALL WAIT
D202 BDD181           (        ch375.asm):00325                 JSR     CH_RD                             ; GET RESULT
D205 BDD189           (        ch375.asm):00326                 JSR     CH_NAP                            ; SMALL WAIT
                      (        ch375.asm):00327         
                      (        ch375.asm):00328         ;
D208 108E0100         (        ch375.asm):00329                 LDY     #$100
D20C                  (        ch375.asm):00330         CH_DISKINIT1:
D20C 8651             (        ch375.asm):00331                 LDA     #CH_CMD_DSKINIT
D20E BDD176           (        ch375.asm):00332                 JSR     CH_CMD                            ; SEND COMMAND
                      (        ch375.asm):00333         
D211 8E8000           (        ch375.asm):00334                 LDX     #$8000
                      (        ch375.asm):00335         !
D214 301F             (        ch375.asm):00336                 DEX
D216 26FC             (        ch375.asm):00337                 BNE     <
                      (        ch375.asm):00338         
D218 BDD1B3           (        ch375.asm):00339                 JSR     CH_POLL
                      (        ch375.asm):00340         
D21B 8114             (        ch375.asm):00341                 CMPA    #$14                              ; SUCCESS?
D21D 270E             (        ch375.asm):00342                 BEQ     CHUSB_RESET1A                     ; IF SO, CHECK READY
D21F 8116             (        ch375.asm):00343                 CMPA    #$16                              ; NO MEDIA
D221 2713             (        ch375.asm):00344                 BEQ     CHUSB_NOMEDIA                     ; HANDLE IT
D223 BDD189           (        ch375.asm):00345                 JSR     CH_NAP                            ; SMALL DELAY
D226 313F             (        ch375.asm):00346                 DEY
D228 26E2             (        ch375.asm):00347                 BNE     CH_DISKINIT1                      ; LOOP AS NEEDED
D22A 7ED232           (        ch375.asm):00348                 JMP     CH_DISKINIT_TO                    ; HANDLE TIMEOUT
                      (        ch375.asm):00349         
D22D                  (        ch375.asm):00350         CHUSB_RESET1A:
D22D BDD24E           (        ch375.asm):00351                 JSR     CH_DSKSIZ                         ; GET AND RECORD DISK SIZE
D230 35B0             (        ch375.asm):00352                 PULS    X,Y,PC
                      (        ch375.asm):00353         
D232                  (        ch375.asm):00354         CH_DISKINIT_TO:
D232 1A01             (        ch375.asm):00355                 SEC
D234 35B0             (        ch375.asm):00356                 PULS    X,Y,PC
                      (        ch375.asm):00357         
D236                  (        ch375.asm):00358         CHUSB_NOMEDIA:
D236 3F               (        ch375.asm):00359                 SWI
D237 19               (        ch375.asm):00360                 FCB     25                                ;DISPLAY MESSAGE
D238 2020434833373520 (        ch375.asm):00361                 FCN     '  CH375 NO MEDIA.'
     4E4F204D45444941
     2E00
D24A 1A01             (        ch375.asm):00362                 SEC
D24C 35B0             (        ch375.asm):00363                 PULS    X,Y,PC
                      (        ch375.asm):00364         
D24E                  (        ch375.asm):00365         CH_DSKSIZ:
D24E 8653             (        ch375.asm):00366                 LDA     #CH_CMD_DSKSIZ                    ; DISK SIZE COMMAND
D250 BDD176           (        ch375.asm):00367                 JSR     CH_CMD                            ; SEND IT
D253 BDD1B3           (        ch375.asm):00368                 JSR     CH_POLL                           ; WAIT FOR RESULT
                      (        ch375.asm):00369         
D256 8114             (        ch375.asm):00370                 CMPA    #$14                              ; SUCCESS?
D258 2631             (        ch375.asm):00371                 BNE     CHUSB_CMDERR                      ; HANDLE CMD ERROR
D25A BDD28E           (        ch375.asm):00372                 JSR     CH_CMD_RD                         ; SEND READ USB DATA CMD
D25D BDD181           (        ch375.asm):00373                 JSR     CH_RD                             ; GET RD DATA LEN
                      (        ch375.asm):00374         
D260 8108             (        ch375.asm):00375                 CMPA    #$08                              ; MAKE SURE IT IS 8
D262 2627             (        ch375.asm):00376                 BNE     CHUSB_CMDERR                      ; HANDLE CMD ERROR
                      (        ch375.asm):00377         
D264 BDD181           (        ch375.asm):00378                 JSR     CH_RD
D267 B75000           (        ch375.asm):00379                 STA     HSTBUF
D26A BDD181           (        ch375.asm):00380                 JSR     CH_RD
D26D B75001           (        ch375.asm):00381                 STA     HSTBUF+1
D270 BDD181           (        ch375.asm):00382                 JSR     CH_RD
D273 B75002           (        ch375.asm):00383                 STA     HSTBUF+2
D276 BDD181           (        ch375.asm):00384                 JSR     CH_RD
D279 B75003           (        ch375.asm):00385                 STA     HSTBUF+3
D27C BDD181           (        ch375.asm):00386                 JSR     CH_RD
D27F BDD181           (        ch375.asm):00387                 JSR     CH_RD
D282 BDD181           (        ch375.asm):00388                 JSR     CH_RD
D285 BDD181           (        ch375.asm):00389                 JSR     CH_RD
D288 1CFE             (        ch375.asm):00390                 CLC
D28A 39               (        ch375.asm):00391                 RTS                                       ; AND DONE
D28B                  (        ch375.asm):00392         CHUSB_CMDERR:
D28B                  (        ch375.asm):00393         CHUSB_IOERR:
D28B 1A01             (        ch375.asm):00394                 SEC
D28D 39               (        ch375.asm):00395                 RTS                                       ; AND DONE
                      (        ch375.asm):00396         
                      (        ch375.asm):00397         
                      (        ch375.asm):00398         
                      (        ch375.asm):00399         ; SEND READ USB DATA COMMAND
                      (        ch375.asm):00400         ; USING BEST OPCODE FOR DEVICE
                      (        ch375.asm):00401         ;
D28E                  (        ch375.asm):00402         CH_CMD_RD:
D28E 8628             (        ch375.asm):00403                 LDA     #CH_CMD_RD5
D290 7ED176           (        ch375.asm):00404                 JMP     CH_CMD
                      (        ch375.asm):00405         ;
                      (        ch375.asm):00406         ; SEND WRITE USB DATA COMMAND
                      (        ch375.asm):00407         ; USING BEST OPCODE FOR DEVICE
                      (        ch375.asm):00408         ;
D293                  (        ch375.asm):00409         CH_CMD_WR:
D293 862B             (        ch375.asm):00410                 LDA     #CH_CMD_WR5
D295 7ED176           (        ch375.asm):00411                 JMP     CH_CMD
                      (        ch375.asm):00412         
D298                  (        ch375.asm):00413         CH_READSEC:
D298 8654             (        ch375.asm):00414                 LDA     #CH_CMD_DSKRD                     ; DISK READ COMMAND
D29A BDD30C           (        ch375.asm):00415                 JSR     CHUSB_RWSTART                     ; SEND CMD AND LBA
                      (        ch375.asm):00416         ;
                      (        ch375.asm):00417         ; READ THE SECTOR IN 64 BYTE CHUNKS
D29D 8E5000           (        ch375.asm):00418                 LDX     #HSTBUF
D2A0 C608             (        ch375.asm):00419                 LDB     #8                                ; 8 CHUNKS OF 64 FOR 512 BYTE SECTOR
D2A2                  (        ch375.asm):00420         CHUSB_READ1:
D2A2 BDD1B3           (        ch375.asm):00421                 JSR     CH_POLL                           ; WAIT FOR DATA READY
D2A5 811D             (        ch375.asm):00422                 CMPA    #$1D                              ; DATA READY TO READ?
D2A7 26E2             (        ch375.asm):00423                 BNE     CHUSB_IOERR                       ; HANDLE IO ERROR
D2A9 BDD28E           (        ch375.asm):00424                 JSR     CH_CMD_RD                         ; SEND READ USB DATA CMD
D2AC BDD181           (        ch375.asm):00425                 JSR     CH_RD                             ; READ DATA BLOCK LENGTH
D2AF 8140             (        ch375.asm):00426                 CMPA    #64                               ; AS EXPECTED?
D2B1 26D8             (        ch375.asm):00427                 BNE     CHUSB_IOERR                       ; IF NOT, HANDLE ERROR
                      (        ch375.asm):00428         ; BYTE READ LOOP
D2B3 3404             (        ch375.asm):00429                 PSHS    B
D2B5 C640             (        ch375.asm):00430                 LDB     #64                               ; READ 64 BYTES
D2B7                  (        ch375.asm):00431         CHUSB_READ2:
D2B7 BDD181           (        ch375.asm):00432                 JSR     CH_RD                             ; GET NEXT BYTE
D2BA A780             (        ch375.asm):00433                 STA     ,X+                               ; SAVE IT
D2BC 5A               (        ch375.asm):00434                 DECB
D2BD 26F8             (        ch375.asm):00435                 BNE     CHUSB_READ2                       ; LOOP AS NEEDED
D2BF 3504             (        ch375.asm):00436                 PULS    B                                 ; RESTORE LOOP CONTROL
                      (        ch375.asm):00437         ;
                      (        ch375.asm):00438         ; PREPARE FOR NEXT CHUNK
D2C1 8655             (        ch375.asm):00439                 LDA     #CH_CMD_DSKRDGO                   ; CONTINUE DISK READ
D2C3 BDD176           (        ch375.asm):00440                 JSR     CH_CMD                            ; SEND IT
D2C6 5A               (        ch375.asm):00441                 DECB
D2C7 26D9             (        ch375.asm):00442                 BNE     CHUSB_READ1                       ; LOOP TILL DONE
                      (        ch375.asm):00443         ;
                      (        ch375.asm):00444         ; FINAL CHECK FOR COMPLETION & SUCCESS
D2C9 BDD1B3           (        ch375.asm):00445                 JSR     CH_POLL                           ; WAIT FOR COMPLETION
D2CC 8114             (        ch375.asm):00446                 CMPA    #$14                              ; SUCCESS?
D2CE 26BB             (        ch375.asm):00447                 BNE     CHUSB_IOERR                       ; IF NOT, HANDLE ERROR
                      (        ch375.asm):00448         ;
D2D0 1CFE             (        ch375.asm):00449                 CLC                                       ; SIGNAL SUCCESS
D2D2 39               (        ch375.asm):00450                 RTS
                      (        ch375.asm):00451         ;
                      (        ch375.asm):00452         ;
                      (        ch375.asm):00453         ;
D2D3                  (        ch375.asm):00454         CH_WRITESEC:
D2D3 8656             (        ch375.asm):00455                 LDA     #CH_CMD_DSKWR                     ; DISK WRITE COMMAND
D2D5 BDD30C           (        ch375.asm):00456                 JSR     CHUSB_RWSTART                     ; SEND CMD AND LBA
                      (        ch375.asm):00457         ;
                      (        ch375.asm):00458         ; WRITE THE SECTOR IN 64 BYTE CHUNKS
D2D8 8E5000           (        ch375.asm):00459                 LDX     #HSTBUF
D2DB C608             (        ch375.asm):00460                 LDB     #8                                ; 8 CHUNKS OF 64 FOR 512 BYTE SECTOR
D2DD                  (        ch375.asm):00461         CHUSB_WRITE1:
D2DD BDD1B3           (        ch375.asm):00462                 JSR     CH_POLL                           ; WAIT FOR DATA READY
D2E0 811E             (        ch375.asm):00463                 CMPA    #$1E                              ; DATA READY TO WRITE
D2E2 26A7             (        ch375.asm):00464                 BNE     CHUSB_IOERR                       ; HANDLE IO ERROR
D2E4 BDD293           (        ch375.asm):00465                 JSR     CH_CMD_WR                         ; SEND WRITE USB DATA CMD
D2E7 8640             (        ch375.asm):00466                 LDA     #64                               ; 64 BYTE CHUNK
D2E9 BDD185           (        ch375.asm):00467                 JSR     CH_WR                             ; SEND DATA BLOCK LENGTH
                      (        ch375.asm):00468         ;
                      (        ch375.asm):00469         ; BYTE WRITE LOOP
D2EC 3404             (        ch375.asm):00470                 PSHS    B                                 ; SAVE LOOP CONTROL
D2EE C640             (        ch375.asm):00471                 LDB     #64                               ; WRITE 64 BYTES
D2F0                  (        ch375.asm):00472         CHUSB_WRITE2:
D2F0 A680             (        ch375.asm):00473                 LDA     ,X+                               ; GET NEXT BYTE
D2F2 BDD185           (        ch375.asm):00474                 JSR     CH_WR                             ; WRITE NEXT BYTE
D2F5 5A               (        ch375.asm):00475                 DECB
D2F6 26F8             (        ch375.asm):00476                 BNE     CHUSB_WRITE2                      ; LOOP AS NEEDED
D2F8 3504             (        ch375.asm):00477                 PULS    B                                 ; RESTORE LOOP CONTROL
                      (        ch375.asm):00478         ;
                      (        ch375.asm):00479         ; PREPARE FOR NEXT CHUNK
D2FA 8657             (        ch375.asm):00480                 LDA     #CH_CMD_DSKWRGO                   ; CONTINUE DISK READ
D2FC BDD176           (        ch375.asm):00481                 JSR     CH_CMD                            ; SEND IT
D2FF 5A               (        ch375.asm):00482                 DECB
D300 26DB             (        ch375.asm):00483                 BNE     CHUSB_WRITE1                      ; LOOP TILL DONE
                      (        ch375.asm):00484         ;
                      (        ch375.asm):00485         ; FINAL CHECK FOR COMPLETION & SUCCESS
D302 BDD1B3           (        ch375.asm):00486                 JSR     CH_POLL                           ; WAIT FOR COMPLETION
D305 8114             (        ch375.asm):00487                 CMPA    #$14                              ; SUCCESS?
D307 2682             (        ch375.asm):00488                 BNE     CHUSB_IOERR                       ; IF NOT, HANDLE ERROR
                      (        ch375.asm):00489         ;
D309 1CFE             (        ch375.asm):00490                 CLC                                       ; SIGNAL SUCCESS
D30B 39               (        ch375.asm):00491                 RTS
                      (        ch375.asm):00492         ;
                      (        ch375.asm):00493         ; INITIATE A DISK SECTOR READ/WRITE OPERATION
                      (        ch375.asm):00494         ; A: READ OR WRITE OPCODE
                      (        ch375.asm):00495         ;
D30C                  (        ch375.asm):00496         CHUSB_RWSTART:
D30C BDD176           (        ch375.asm):00497                 JSR     CH_CMD                            ; SEND R/W COMMAND
                      (        ch375.asm):00498         ;
                      (        ch375.asm):00499         ; SEND LBA, 4 BYTES, LITTLE ENDIAN
D30F 9650             (        ch375.asm):00500                 LDA     CURRENTSEC
D311 BDD185           (        ch375.asm):00501                 JSR     CH_WR                             ; SEND BYTE
D314 9651             (        ch375.asm):00502                 LDA     CURRENTCYL
D316 4C               (        ch375.asm):00503                 INCA                                      ; CYL 0 reserved for boot image
D317 BDD185           (        ch375.asm):00504                 JSR     CH_WR                             ; SEND BYTE
D31A 9652             (        ch375.asm):00505                 LDA     CURRENTSLICE                      ;
D31C BDD185           (        ch375.asm):00506                 JSR     CH_WR                             ; SEND BYTE
D31F 8600             (        ch375.asm):00507                 LDA     #0                                ;
D321 BDD185           (        ch375.asm):00508                 JSR     CH_WR                             ; SEND BYTE
                      (        ch375.asm):00509         ; REQUEST 1 SECTOR
D324 8601             (        ch375.asm):00510                 LDA     #1                                ;
D326 BDD185           (        ch375.asm):00511                 JSR     CH_WR                             ; SEND BYTE
D329 39               (        ch375.asm):00512                 RTS
                      (        ch375.asm):00513         ;

Symbol Table:
[ G] CH0BASE                          1260
[ G] CH0COMMAND                       1261
[ G] CH0DATA                          1260
[ G] CH375                            D000
[ G] CH375INIT                        D0BF
[ G] CH_CMD                           D176
[ G] CH_CMD_ABRTNAK                   0017
[ G] CH_CMD_AUTOSET                   004D
[ G] CH_CMD_BYTE_LOC                  0039
[ G] CH_CMD_BYTERD                    003A
[ G] CH_CMD_BYTERDGO                  003B
[ G] CH_CMD_BYTEWR                    003C
[ G] CH_CMD_BYTEWRGO                  003D
[ G] CH_CMD_DSKCAP                    003E
[ G] CH_CMD_DSKINIT                   0051
[ G] CH_CMD_DSKINQ                    0058
[ G] CH_CMD_DSKMNT                    0031
[ G] CH_CMD_DSKRD                     0054
[ G] CH_CMD_DSKRDGO                   0055
[ G] CH_CMD_DSKRDY                    0059
[ G] CH_CMD_DSKRES                    0052
[ G] CH_CMD_DSKSIZ                    0053
[ G] CH_CMD_DSKWR                     0056
[ G] CH_CMD_DSKWRGO                   0057
[ G] CH_CMD_EXIST                     0006
[ G] CH_CMD_MAXLUN                    000A
[ G] CH_CMD_MODE                      0015
[ G] CH_CMD_PKTSEC                    000B
[ G] CH_CMD_RD                        D28E
[ G] CH_CMD_RD5                       0028
[ G] CH_CMD_RESET                     0005
[ G] CH_CMD_SETRETRY                  000B
[ G] CH_CMD_STAT                      0022
[ G] CH_CMD_TSTCON                    0016
[ G] CH_CMD_VER                       0001
[ G] CH_CMD_WR                        D293
[ G] CH_CMD_WR5                       002B
[ G] CH_DETECT                        D144
[ G] CH_DETECT1                       D163
[ G] CH_DISKINIT                      D1E0
[ G] CH_DISKINIT1                     D20C
[ G] CH_DISKINIT_TO                   D232
[ G] CH_DSKSIZ                        D24E
[ G] CH_NAP                           D189
[ G] CH_POLL                          D1B3
[ G] CH_POLL0                         D1B9
[ G] CH_POLL1                         D1BC
[ G] CH_POLL2                         D1D0
[ G] CH_RD                            D181
[ G] CH_READSEC                       D298
[ G] CH_RES1                          D1A6
[ G] CH_RESET                         D19B
[ G] CH_STAT                          D17D
[ G] CH_WR                            D185
[ G] CH_WRITESEC                      D2D3
[ G] CHUSB_CMDERR                     D28B
[ G] CHUSB_IOERR                      D28B
[ G] CHUSB_NOMEDIA                    D236
[ G] CHUSB_READ1                      D2A2
[ G] CHUSB_READ2                      D2B7
[ G] CHUSB_RESET1A                    D22D
[ G] CHUSB_RWSTART                    D30C
[ G] CHUSB_WRITE1                     D2DD
[ G] CHUSB_WRITE2                     D2F0
[ G] CR                               000D
[ G] CURRENTCYL                       0051
[ G] CURRENTSEC                       0050
[ G] CURRENTSLICE                     0052
[ G] DUMPSEC                          D09F
[ G] DUMPSEC1                         D0A2
[ G] DUMPSEC2                         D0AC
[ G] ESCCHR                           001B
[ G] FILLSEC                          D094
[ G] FILLSEC1                         D097
[ G] HSTBUF                           5000
[ G] LF                               000A
[ G] NOTDETECTED                      D129
[ G] OSEND                            DBFF
[ G] OSRAM                            2000
[ G] OSUTIL                           D000
[ G] PAGSIZ                           0016
[ G] TAB                              0009
